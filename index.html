<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pong Dev</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #pong {
        display: block;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <canvas id="pong"></canvas>
    <script type="module">
      import { createPong } from "./src/client/entry/embed.ts";

      // ——— 1) Minimal error overlay ———
      function showErrorOverlay(text) {
        const box = document.createElement("div");
        box.role = "alert";
        box.ariaLive = "assertive";
        box.style.cssText =
          "position:fixed;inset:0;display:grid;place-items:center;z-index:99999;" +
          "background:rgba(0,0,0,.35);backdrop-filter:saturate(1.2) blur(1px)";
        const card = document.createElement("div");
        card.style.cssText =
          "max-width:520px;padding:16px 18px;border-radius:14px;" +
          "background:#111;color:#eee;font:14px system-ui,Segoe UI,Roboto,Ubuntu;" +
          "box-shadow:0 8px 30px rgba(0,0,0,.35)";
        card.innerHTML = `
          <strong style="display:block;margin-bottom:8px">Pong failed to start</strong>
          <div style="opacity:.9;white-space:pre-wrap">${text}</div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button id="pong-overlay-dismiss"
              style="padding:6px 10px;border:0;border-radius:10px;background:#2a2a2a;color:#eee;cursor:pointer">
              Dismiss
            </button>
          </div>`;
        box.appendChild(card);
        document.body.appendChild(box);
        document
          .getElementById("pong-overlay-dismiss")
          ?.addEventListener("click", () => box.remove());
      }

      // ——— 2) Global safety nets ———
      // Synchronous runtime errors not caught by try/catch
      window.addEventListener("error", (e) => {
        // Let devtools & Vite overlay still see it:
        console.error("[Pong] Uncaught error:", e.error || e.message, e);
        // Show a compact message to users (avoid leaking stack details in prod if you prefer)
        showErrorOverlay(
          String(e.error?.message || e.message || "Unexpected error"),
        );
      });

      // Unhandled Promise rejections
      window.addEventListener("unhandledrejection", (e) => {
        console.error("[Pong] Unhandled rejection:", e.reason, e);
        showErrorOverlay(
          String(e.reason?.message || e.reason || "Unexpected async error"),
        );
      });

      // ——— 3) Defensive initialization ———
      try {
        const el = document.getElementById("pong");
        if (!(el instanceof HTMLCanvasElement)) {
          throw new Error("Missing <canvas id='pong'> or wrong element type.");
        }

        const pong = createPong(el, { antialias: true });
        pong.start();

        // Optional cleanup for SPA routing / tab close
        window.addEventListener("beforeunload", () => pong.destroy());
      } catch (err) {
        console.error("[Pong] Startup failed:", err);
        showErrorOverlay(String(err instanceof Error ? err.message : err));
      }
    </script>
  </body>
</html>
